<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Models</title>

<script src="site_libs/header-attrs-2.18/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Maddy Kline BST260 Final Project 2022</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Introduction</a>
</li>
<li>
  <a href="Mapping.html">Mapping</a>
</li>
<li>
  <a href="Models.html">Models</a>
</li>
<li>
  <a href="conclusions.html">Conclusions</a>
</li>
<li>
  <a href="references.html">References</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Models</h1>

</div>


<p>I will fit a model to better understand drivers of regional patterns
of streptococcal pharyngitis. I will first consider all age groups
across all years of data (2010-2018), and with possible covariates
region, year, month, flu vaccination (monthly), and flu cases. I am
using a linear regression model because streptococcal pharyngitis cases
are already reported as total counts for a given year and month, so with
large enough amounts of data, the errors will follow a normal
distribution. In order to select an optimal model, I tested multiple
combinations of parameters, and compared the <span
class="math inline">\(R^2\)</span> values of these models to start. I
used an adjusted <span class="math inline">\(R^2\)</span>, which is
calculated using a penalty for parameters <span
class="math inline">\(R^2_{adj} = R^2 -
\frac{p(1-R^2)}{(n-p-1)}\)</span> where <span class="math inline">\(R^2
= 1- \frac{\sum_{i=1}^n (y_i -\hat{y_i})}{\sum_{i=1}^n (y_i
-\bar{y})}\)</span>.</p>
<p><img src="Models_files/figure-html/unnamed-chunk-12-1.png" width="480" /></p>
<p>We can see that <span class="math inline">\(R^2_{adj}\)</span>
largely increases as number of parameters increase, although not always
(the model with Region, Year, and Month has a higher<span
class="math inline">\(R^2_{adj}\)</span> than the model with Region,
Month, Flu coverage, and Flu cases). Larger values of <span
class="math inline">\(R^2_{adj}\)</span> mean that the model accounts
for a greater proportion of the variability of the outcome. The model
with the highest <span class="math inline">\(R^2_{adj}\)</span> contains
region, year, month, flu vaccination, flu cases, and a statistical
interaction term bewteen year and month, and has an <span
class="math inline">\(R^2_{adj}\)</span> of 0.89, The model with the
second highest <span class="math inline">\(R^2_{adj}\)</span> contains
region, year, month, flu vaccination, and flu cases, without a
statistical interaction term between year and month. This model has an
<span class="math inline">\(R^2_{adj}\)</span> of 0.88.</p>
<p>We can also use the Akaike Information Criterion (AIC), calculated as
<span class="math inline">\(AIC = -2log(\hat{L}) + 2(p+1)\)</span> where
<span class="math inline">\(\hat{L}\)</span> is the maximum likelihood
of the model, and p is number of parameters. The rationale for this
criterion is that the likelihood must go up by more than is justified by
the additional parameters added. Lower AIC values are better.</p>
<p><img src="Models_files/figure-html/unnamed-chunk-13-1.png" width="480" /></p>
<p>The model with the lowest AIC contains region, year, month, flu
vaccination, and flu cases, without a statistical interaction between
year and month. This model also has the second highest <span
class="math inline">\(R^2_{adj}\)</span> so, it is likely the best fit
of the available models. We can visualize our model’s predictions
against the observed data.</p>
<p><img src="Models_files/figure-html/unnamed-chunk-14-1.png" width="1440" /></p>
<p>The model (solid line) generally tracks well with observed cases of
streptococcal pharyngitis. We can next plot the model predictions with
corresponding 95% confidence intervals against observed cases for each
region separately.</p>
<p><img src="Models_files/figure-html/unnamed-chunk-15-1.png" width="1152" /></p>
<p>At this finer resolution, the model appears to predict cases in the
South well, though it does not always capture the steep rise in cases in
the fall and early winter. It somewhat overpredicts seasonal changes in
the West (it predicts more cases in the beginning of the year and fewer
in the early winter than are observed), and it predicts the Northeast
and Midwest relatively faithfully.</p>
<p>We next apply a similar strategy also including PCV vaccination data.
Because PCV vaccination from the CDC is broken down by birth cohort, we
include data from the 2011, 2012, and 2013 birth cohorts and compare
children in these cohorts who received all 4 doses to cases of
streptococcal pharyngitis and flu in children ages 5-9 in years 2016,
2017, and 2018, when the children from these birth cohorts enter this
age range. Flu vaccination data are taken from chidlren in the 5-12 year
old age range. As before, we first compare <span
class="math inline">\(R^2_{adj}\)</span> for linear models with
different parameters.</p>
<p><img src="Models_files/figure-html/unnamed-chunk-16-1.png" width="480" /></p>
<p>The model with the highest value of <span
class="math inline">\(R^2_{adj}\)</span> here is not the model with the
most parameters, but rather includes region, year, month, flu
vaccination and flu cases. The <span
class="math inline">\(R^2_{adj}\)</span> for this model is 0.88,
indicating that it explains about 88% of the variability in
streptococcal pharyngitis cases. Notably, models including PCV
vaccination have lower <span class="math inline">\(R^2_{adj}\)</span>
values, indicating that this covariate does not help to explain
variation in cases of streptococcal pharyngitis. We next compare AIC for
each model.</p>
<p><img src="Models_files/figure-html/unnamed-chunk-17-1.png" width="480" /></p>
<p>Here, the lowest AIC also corresponds to the same model with the
highest <span class="math inline">\(R^2_{adj}\)</span>, indicating that
this is the best available model. We can again visualize our model’s
predictions against observed data.</p>
<p><img src="Models_files/figure-html/unnamed-chunk-18-1.png" width="1440" /></p>
<p>The models once again track reasonably well with observed data. We
can zoom in on predictions in each region as before.</p>
<p><img src="Models_files/figure-html/unnamed-chunk-19-1.png" width="1152" />
Here we see similar trends as before, which makes sense given that we
have essentially fit the same model just in years 2016-2018, and with
only 5-9 year olds (the age group with the highest burden of
disease).</p>
<div id="appendix" class="section level2">
<h2>Appendix</h2>
<pre class="r"><code>knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(ggplot2)
library(usmap)
library(gridExtra)
library(maps)
library(mapdata)
library(ggmap)
library(lmtest)

#Read in data on cases
dat &lt;- read_csv(&quot;/Users/madeleinekline/Dropbox (Harvard University)/G1/GradLab/StrepPharyngitis/output/GeoVisits.csv&quot;)

#Read in data on membership
coh &lt;- read_csv(&quot;/Users/madeleinekline/Dropbox (Harvard University)/G1/GradLab/StrepPharyngitis/output/GeoCohort.csv&quot;)
#this dataframe has population by sex, age group, and state but not by month. So need to add it to the other dataframe once already collapsed by year. 

#get data by year, rather than by month:
by_year &lt;- aggregate(NVISITS ~ YEAR + STATE + SEX + AGEGRP + PRIMARYCOND, dat, sum)
#we can then join this with the population data from cohort
by_year &lt;- left_join(by_year, coh)

# by_year |&gt; group_by(YEAR) |&gt; summarize(total_vis = sum(NVISITS), total_memb = sum(NMEMB), CI = round(total_vis/total_memb,4)) |&gt; ggplot(aes(x=YEAR, y = CI)) + geom_bar(stat = &quot;identity&quot;, fill = &quot;steelblue&quot;) + theme_bw() + geom_text(aes(label=CI), vjust=1.6, color=&quot;white&quot;, size=2.0) + ylab(&quot;Cases per person&quot;) +  ggtitle(&quot;Total Strep Pharyngitis Visits per Member by Year US&quot;)


#let&#39;s summarize cumulative incidence by state across years to start
by_state &lt;- by_year |&gt;
  group_by(YEAR, STATE) |&gt;
  summarize(visits = sum(NVISITS), members = sum(NMEMB), CI = visits/members)

#we now manipulate the data slightly to show CI per hundred, and make the state names match the mapping dataframe
strep_all &lt;- by_state |&gt; mutate(region = tolower(STATE), CI_per_hundred = CI*100) |&gt;
  select(region, CI_per_hundred)



#now we add region designations for &quot;northeast&quot;, &quot;south&quot;, &quot;midwest&quot;, and &quot;west&quot;
#add regions to this dataframe
#make a function that converts lists of state abbreviations to lists of state names
to_statename &lt;- function(list){
  new_list &lt;- c()
  for(i in 1:length(list)){
    name &lt;- state.name[grep(list[i], state.abb)] 
    new_list &lt;- append(new_list, name)
  }
  new_list
}

northeast_states &lt;- tolower(to_statename(.northeast_region))
midwest_states &lt;- tolower(to_statename(.midwest_region))
south_states &lt;- tolower(to_statename(.south_region))
west_states &lt;- tolower(to_statename(.west_region))

northeast_df &lt;- data.frame(region = northeast_states, part = &quot;northeast&quot;) 
midwest_df &lt;- data.frame(region = midwest_states, part = &quot;midwest&quot;)   
south_df &lt;- data.frame(region = south_states, part = &quot;south&quot;) 
west_df &lt;- data.frame(region = west_states, part = &quot;west&quot;)
#will put dc in the south because maryland and viriginia are
dc_df &lt;- data.frame(region = &quot;washington dc&quot;, part = &quot;south&quot;)


state_parts &lt;- rbind(northeast_df, midwest_df, south_df, west_df, dc_df)


strep_all_region &lt;- left_join(strep_all, state_parts, by = &quot;region&quot;)

#now we look at the data by age group across all regions
by_year &lt;- by_year |&gt; mutate(&quot;state&quot; = STATE)
by_year_age_visits &lt;- aggregate(NVISITS ~ YEAR + state + AGEGRP + PRIMARYCOND, dat = by_year, sum)
by_year_age_membs &lt;- aggregate(NMEMB ~ YEAR + state + AGEGRP + PRIMARYCOND, dat = by_year, sum)
by_year_age &lt;- left_join(by_year_age_visits, by_year_age_membs)
by_year_age &lt;- by_year_age |&gt; mutate(CI_per_hundred = NVISITS/NMEMB *100, state = tolower(state))

#add in region just in case?
state_parts_2 &lt;- state_parts
names(state_parts_2)[1] &lt;- &quot;state&quot;

by_year_age &lt;- left_join(by_year_age, state_parts_2)
#make a plot of trends over time by state


country_by_age &lt;- left_join(aggregate(NVISITS ~ AGEGRP + YEAR, dat = by_year_age, sum), aggregate(NMEMB ~ AGEGRP + YEAR, dat = by_year_age, sum))
country_by_age &lt;- country_by_age |&gt; mutate(CI_per_hundred = NVISITS/NMEMB * 100)

# country_by_age |&gt; ggplot(aes(YEAR, CI_per_hundred, group = AGEGRP)) + geom_line(aes(color = AGEGRP)) + ggtitle(&quot;Streptococcal Pharyngitis in the US from 2010-2018 \n By Age Group&quot;) + theme_bw() + ylab(&quot;Cases per 100 People&quot;) + labs(color = &quot;Age Group&quot;)



states_indiv_region &lt;- strep_all_region |&gt; group_by(YEAR, region) |&gt; ggplot(aes(YEAR, CI_per_hundred, group=region)) + geom_line(aes(col = part)) + ggtitle(&quot;Streptococcal Pharyngitis In All States by Region&quot;) + ylab(&quot;Cases per 100 People&quot;) + theme_bw() + labs(color = &quot;Region&quot;)

#now group them by region and just report 1 value per region

by_state_2 &lt;- by_state |&gt; mutate(state = tolower(STATE))
strep_region_visits &lt;- left_join(by_state_2, state_parts_2, by = &quot;state&quot;)
strep_region_visits_agg &lt;- aggregate(visits~ part + YEAR, dat = strep_region_visits, sum)
strep_region_members_agg &lt;- aggregate(members~ part + YEAR, dat = strep_region_visits, sum)
strep_region_joined &lt;- left_join(strep_region_visits_agg, strep_region_members_agg)
strep_region_joined &lt;- strep_region_joined |&gt; mutate(CI_per_hundred = visits/members * 100)

per_region&lt;- strep_region_joined |&gt; group_by(YEAR, part) |&gt; ggplot(aes(YEAR, CI_per_hundred, group=part)) + geom_line(aes(col = part)) + ggtitle(&quot;Streptococcal Pharyngitis By Region&quot;) +ylab(&quot;Cases per 100 People&quot;) + theme_bw() + labs(color = &quot;Region&quot;)

#grid.arrange(states_indiv_region, per_region, ncol=2)

#try by month; first just plot data by region for all age groups together
#should be able to just merge these two because the members are stable over the year
by_month_all &lt;- left_join(dat, coh)

#consolidate across sex and check if this is what you needed to do earlier on as well;
#to consolidate across sex, will just need to add so that should be fine 
by_month_age_vis &lt;- aggregate(NVISITS ~ MONTH + STATE + AGEGRP + YEAR, dat = by_month_all, sum)
memb_no_sex &lt;- aggregate(NMEMB ~  STATE +AGEGRP + YEAR, dat = coh, sum)
by_month_no_sex &lt;- left_join(by_month_age_vis, memb_no_sex)
by_month_no_sex &lt;- by_month_no_sex |&gt; mutate(&quot;CI_per_thousand&quot; = NVISITS/NMEMB*1000)



by_month_no_sex_lowercase &lt;- by_month_no_sex |&gt; mutate(&quot;state&quot; = tolower(STATE))
by_month_regions &lt;- left_join(by_month_no_sex_lowercase, state_parts_2, by = &quot;state&quot;)
by_month_regions_only_vis &lt;- aggregate(NVISITS ~ part  + YEAR + MONTH, 
                                       dat = by_month_regions,
                                       sum)
by_month_regions_only_memb &lt;- aggregate(NMEMB ~ part  + YEAR + MONTH, 
                                       dat = by_month_regions,
                                       sum)


by_month_regions_only &lt;- left_join(by_month_regions_only_vis, by_month_regions_only_memb)
by_month_regions_only &lt;- by_month_regions_only |&gt; mutate(&quot;CI_per_thousand&quot; = NVISITS/NMEMB *1000)
# by_month_regions_only |&gt; ggplot(aes(x = MONTH, y = CI_per_thousand, group = part)) + 
#   geom_line(aes(color = part)) +
#   facet_wrap(~YEAR) + ggtitle(&quot;Steptococcal Pharyngitis Cases Incidence by Month \n All Ages, by Region&quot;) + labs(color = &quot;Region&quot;) + ylab(&quot;Cases per 1,000 People&quot;) +scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;,
#                                                                                                                                    &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))



#we now load in US mapping data from the maps package
us_df &lt;- map_data(&quot;state&quot;)

#this creates a base US map to build upon
us_base &lt;- ggplot(data = us_df, mapping = aes(x = long, y = lat, group =group))+
  coord_fixed(1.3) + geom_polygon(color=&quot;black&quot;, fill = &quot;gray&quot;)

#we join our dataframe with strep info with our mapping dataframe
us_strep_all &lt;- inner_join(us_df, strep_all, by = &quot;region&quot;)
# us_strep_rates_over_time &lt;- us_base + geom_polygon(data = us_strep_all, aes(fill = CI_per_hundred))+
#   geom_polygon(color = &quot;gray&quot;, fill = NA) + theme(
#   axis.text = element_blank(),
#   axis.line = element_blank(),
#   axis.ticks = element_blank(),
#   panel.border = element_blank(),
#   panel.grid = element_blank(),
#   axis.title = element_blank()
#   ) + facet_wrap(~YEAR) + scale_fill_gradient(low = &quot;#FFFFFF&quot;, high = &quot;#FF0000&quot; ) + ggtitle(&quot;Cumulative Incidence of Streptococcal Pharyngitis from 2010-2018 \n All Ages&quot;) + labs(fill = &quot;Cases per 100 People&quot;)
# us_strep_rates_over_time


#making maps for age group trends over time
by_year_age_formap &lt;- by_year_age
names(by_year_age_formap)[2] = &quot;region&quot;
us_strep_byage_map &lt;- inner_join(us_df, by_year_age_formap, by = &quot;region&quot;)
#attempt facet_grid with year as the column and age group as the row
# us_strep_byage_map_gg &lt;- us_base + 
#   geom_polygon(data = us_strep_byage_map, aes(fill = CI_per_hundred)) +
#     geom_polygon(color = &quot;gray&quot;, fill = NA) + 
#   theme(
#   axis.text = element_blank(),
#   axis.line = element_blank(),
#   axis.ticks = element_blank(),
#   panel.border = element_blank(),
#   panel.grid = element_blank(),
#   axis.title = element_blank()
#   ) + scale_fill_gradient(low = &quot;#FFFFFF&quot;, high = &quot;#FF0000&quot; ) + ggtitle(&quot;Cumulative Incidence of Streptococcal Pharyngitis from 2010-2018 \n By Age Group&quot;) + labs(fill = &quot;Cases per 100 People&quot;)
# 
# us_strep_byage_map_gg + facet_grid(rows = vars(AGEGRP), cols = vars(YEAR) )
#now for flu case data
flu_dat &lt;- read_csv(&quot;/Users/madeleinekline/Dropbox (Harvard University)/G1/GradLab/StrepPharyngitis/output/GeoVisitsFlu.CSV&quot;)
flu_coh &lt;- read_csv(&quot;/Users/madeleinekline/Dropbox (Harvard University)/G1/GradLab/StrepPharyngitis/output/GeoCohortFlu.csv&quot;) #this is the same as strep data

#do same thing that did for strep cases to start
#should be able to just merge these two because the members are stable over the year
by_month_all_flu &lt;- left_join(flu_dat, flu_coh)

flu_by_month_age_vis &lt;- aggregate(NVISITS ~ MONTH + STATE + AGEGRP + YEAR, dat = by_month_all_flu, sum)
flu_memb_no_sex &lt;- aggregate(NMEMB ~  STATE +AGEGRP + YEAR, dat = flu_coh, sum)
flu_by_month_no_sex &lt;- left_join(flu_by_month_age_vis, flu_memb_no_sex)
flu_by_month_no_sex &lt;- flu_by_month_no_sex |&gt; 
  mutate(&quot;CI_per_thousand&quot; = NVISITS/NMEMB*1000) |&gt;
  mutate(&quot;CI_per_ten_thousand&quot; =NVISITS/NMEMB*10000 )

flu_by_month_no_sex_lowercase &lt;- flu_by_month_no_sex |&gt; mutate(&quot;state&quot; = tolower(STATE))
flu_by_month_regions &lt;- left_join(flu_by_month_no_sex_lowercase, state_parts_2, by = &quot;state&quot;)
flu_by_month_regions_only_vis &lt;- aggregate(NVISITS ~ part  + YEAR + MONTH, 
                                       dat = flu_by_month_regions,
                                       sum)
flu_by_month_regions_only_memb &lt;- aggregate(NMEMB ~ part  + YEAR + MONTH, 
                                       dat = flu_by_month_regions,
                                       sum)

flu_by_month_regions_only &lt;- left_join(flu_by_month_regions_only_vis, flu_by_month_regions_only_memb)
flu_by_month_regions_only &lt;- flu_by_month_regions_only |&gt; mutate(&quot;CI_per_thousand&quot; = NVISITS/NMEMB *1000,
                                                                 &quot;CI_per_ten_thousand&quot; = NVISITS/NMEMB *10000,
                                                                 &quot;CI_per_hundred_thousand&quot; = NVISITS/NMEMB *100000)

# flu_by_month_regions_only |&gt; ggplot(aes(x = MONTH, y = CI_per_thousand, group = part)) + 
#   geom_line(aes(color = part)) + scale_y_continuous(trans = &quot;log10&quot;) +
#   facet_wrap(~YEAR) + scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;,
#                                                                                                                                    &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + ggtitle(&quot;Flu Cases Over Time \n All Ages&quot;) 

#need to figure out where data is missing 

flu_vax &lt;- read_csv(&quot;/Users/madeleinekline/Dropbox (Harvard University)/G1/GradLab/flu_data/Influenza_Vaccination_Coverage_for_All_Ages__6__Months_.csv&quot;)

flu_vax_filt &lt;- flu_vax |&gt; 
  filter(`Season/Survey Year` %in% c(&quot;2009-10&quot;, &quot;2010-11&quot;, &quot;2011-12&quot;,
                                                                   &quot;2012-13&quot;, &quot;2013-14&quot;, &quot;2014-15&quot;,
                                                                   &quot;2015-16&quot;, &quot;2016-17&quot;, &quot;2017-18&quot;,
                                                                   &quot;2018-19&quot;)) |&gt;
  filter(Dimension %in% c(&quot;≥6 Months&quot;,&quot;6 Months - 17 Years&quot;, &quot;≥18 Years&quot; , &quot;6 Months - 4 Years&quot; ,
                          &quot;5-12 Years&quot;,  &quot;13-17 Years&quot;)) |&gt;
  mutate(state = tolower(Geography)) |&gt;
  filter(state %in% state_parts_2$state) |&gt;
  select(-`Geography Type`, -Vaccine, -FIPS, -`Dimension Type`)

#need to put the years on the same year scale as the cases data
flu_vax_filt &lt;- flu_vax_filt |&gt; mutate(year_lower = substr(`Season/Survey Year`, 1,4),
                       year_higher = paste0(&quot;20&quot;,str_sub(`Season/Survey Year`, -2, -1)),
                       year = ifelse(Month %in% c(7,8,9,10,11,12), year_lower, 
                                     ifelse(Month %in% c(1,2,3,4,5), year_higher, NA)),
                       state = tolower(Geography),
                       coverage = as.numeric(`Estimate (%)`))

#add region to this 
flu_vax_filt &lt;- left_join(flu_vax_filt, state_parts_2, by= &quot;state&quot;)
flu_vax_filt_2 &lt;- flu_vax_filt |&gt; mutate(STATE = Geography, YEAR = as.numeric(year)) |&gt;
  select(Month, STATE, Dimension, `Estimate (%)`,YEAR, part) |&gt; filter(YEAR != 2009)

#for the sake of the geographic analysis, I will show flu vaccination rates in 5-9 year olds by november of each year in each state
fluvax_map &lt;- flu_vax_filt_2 |&gt; 
  filter(Dimension == &quot;5-12 Years&quot;, Month == 11 ) |&gt; 
  mutate(region = tolower(STATE)) |&gt;
  left_join(us_df)
  
# us_base + geom_polygon(data = fluvax_map, aes(fill = as.numeric(`Estimate (%)`)))+
#   geom_polygon(color = &quot;gray&quot;, fill = NA) + theme(
#   axis.text = element_blank(),
#   axis.line = element_blank(),
#   axis.ticks = element_blank(),
#   panel.border = element_blank(),
#   panel.grid = element_blank(),
#   axis.title = element_blank()
#   ) + facet_wrap(~YEAR) + scale_fill_gradient(low = &quot;#FFFFFF&quot;, high = &quot;#F05E16&quot; ) + ggtitle(&quot;November Flu Vaccination Coverage&quot;)
# 
# fluvax_map$YEAR


#now take &gt;6 months, which is vaccination in all ages. Do 5-12 separately
flu_vax_filt_allages &lt;- flu_vax_filt_2 |&gt; filter(Dimension == &quot;≥6 Months&quot;)

#get the cohort membership by state from the original dataframe
coh_fluvax_allages &lt;- aggregate(NMEMB ~ STATE + YEAR, data = coh, sum)
flu_vax_rescale_allages &lt;- left_join(flu_vax_filt_allages, coh_fluvax_allages) |&gt; 
  mutate(sample_vaxxed = as.numeric(`Estimate (%)`)*1/100*NMEMB)
#aggregate the members and sample vaxxed
flu_vax_rescale_allages_memb &lt;- aggregate(NMEMB ~ part + YEAR + Month, data = flu_vax_rescale_allages, sum)
flu_vax_rescale_allages_vax &lt;- aggregate(sample_vaxxed ~ part + YEAR + Month, data = flu_vax_rescale_allages, sum)
flu_vax_rescale_allages_comb &lt;- left_join(flu_vax_rescale_allages_vax, flu_vax_rescale_allages_memb) |&gt; mutate(flu_coverage = sample_vaxxed / NMEMB* 100)


#aggregate(NMEMB ~ STATE + YEAR, data = by_month_regions, sum)
#aggregate(NMEMB ~ STATE + YEAR, data = flu_by_month_regions, sum)
#these are different by a factor of 12, which makes sense because in one case I am summing over all the months.
#I think this is still what I want, but need to check with stephen. Shouldn&#39;t affect scaling though cuz its just off by a factor of 12 which will come out regardless

#do the same thing for the 5-9 age group
flu_vax_filt_512 &lt;- flu_vax_filt_2 |&gt; filter(Dimension == &quot;5-12 Years&quot;)
coh_fluvax_59 &lt;- aggregate(NMEMB~ STATE + YEAR + AGEGRP, data = coh, sum) |&gt; filter(AGEGRP == &quot;05_09&quot;)
flu_vax_rescale_5 &lt;- left_join(flu_vax_filt_512, coh_fluvax_59) |&gt; mutate(sample_vaxxed = as.numeric(`Estimate (%)`)*1/100*NMEMB)
flu_vax_rescale_5_memb &lt;- aggregate(NMEMB ~ part + YEAR + Month, data = flu_vax_rescale_5, sum)
flu_vax_rescale_5_vax &lt;- aggregate(sample_vaxxed ~ part + YEAR + Month, data = flu_vax_rescale_5, sum)
flu_vax_rescale_5_comb &lt;- left_join(flu_vax_rescale_5_memb, flu_vax_rescale_5_vax) |&gt;
  mutate(flu_coverage = sample_vaxxed / NMEMB * 100)

#plot the strep and flu vaccine data ontop of one another for all ages, and for 5-9 age group specifically
flu_vax_rescale_allages_comb &lt;- flu_vax_rescale_allages_comb |&gt; mutate(MONTH = Month) |&gt; select(-Month)
joint2 &lt;- by_month_regions_only |&gt; select(-NVISITS, -NMEMB) |&gt; left_join(flu_vax_rescale_allages_comb) |&gt;
  select(-sample_vaxxed, -NMEMB) |&gt; mutate(Strep_CI_per_ten_thousand = CI_per_thousand*10)
joint2_pivot &lt;- joint2|&gt; pivot_longer(cols = c(&quot;Strep_CI_per_ten_thousand&quot;, &quot;flu_coverage&quot;))
fluvax_strep_allages_plot &lt;- joint2_pivot |&gt; ggplot(aes(x= MONTH, y = value, color = part)) + 
  geom_line(aes(linetype = name)) + 
  facet_wrap(~YEAR) + scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;,
                                                                                                                                   &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + ggtitle(&quot;Strep Pharyngitis Rates and Flu Vaccination Over Time  \n All Ages, scaled to MarketScan maybe&quot;) + labs(linetype = &quot;Value Plotted&quot;) + labs(color = &quot;Region&quot;) + scale_linetype_discrete(labels = c(&quot;Flu Vaccination %&quot;, &quot;Strep cases per 10,000&quot;))


#for 5-9 age group
by_month_regions_5 &lt;- by_month_regions |&gt; filter(AGEGRP %in% c(&quot;05_09&quot;))
by_month_regions_5_vis &lt;- aggregate(NVISITS ~ part  + YEAR + MONTH, 
                                       dat = by_month_regions_5,
                                       sum)
by_month_regions_5_memb &lt;- aggregate(NMEMB ~ part  + YEAR + MONTH, 
                                       dat = by_month_regions_5,
                                       sum)
by_month_regions_5 &lt;- left_join(by_month_regions_5_vis, by_month_regions_5_memb)
by_month_regions_5 &lt;- by_month_regions_5 |&gt; mutate(&quot;CI_per_thousand&quot; = NVISITS/NMEMB *1000)
#fluvax data
flu_vax_rescale_5_comb &lt;- flu_vax_rescale_5_comb |&gt; mutate(MONTH = Month) |&gt; select(-Month)
joint3 &lt;- by_month_regions_5 |&gt; select(-NVISITS, -NMEMB) |&gt; left_join(flu_vax_rescale_5_comb) |&gt;
  select(-sample_vaxxed, -NMEMB) |&gt; mutate(Strep_CI_per_ten_thousand = CI_per_thousand*10, Strep_CI_per_five_thousand = CI_per_thousand*5, Strep_CI_per_two_thousand = CI_per_thousand*2)
joint3_pivot &lt;- joint3 |&gt; pivot_longer(cols = c(&quot;Strep_CI_per_two_thousand&quot;, &quot;flu_coverage&quot;))
fluvax_strep_59_plot &lt;- joint3_pivot |&gt; ggplot(aes(x= MONTH, y = value, color = part)) + 
  geom_line(aes(linetype = name)) + 
  facet_wrap(~YEAR) + scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;,
                                                                                                                                   &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + ggtitle(&quot;Strep Pharyngitis Rates and Flu Vaccination Over Time  \n 5-9 Age Group&quot;) + labs(linetype = &quot;Value Plotted&quot;) + labs(color = &quot;Region&quot;) + scale_linetype_discrete(labels = c(&quot;Flu Vaccination %&quot;, &quot;Strep cases per 2,000&quot;))

# fluvax_strep_allages_plot
# fluvax_strep_59_plot
childvax_data &lt;- read_csv(&quot;/Users/madeleinekline/Dropbox (Harvard University)/G1/GradLab/vax_data/Vaccination_Coverage_among_Young_Children__0-35_Months_.csv&quot;)
pcv_vax &lt;- childvax_data |&gt; filter(Vaccine == &quot;PCV&quot;)
pcv_4d_35m &lt;- pcv_vax |&gt; filter(Dose == &quot;≥4 Doses&quot;) |&gt; filter(Dimension == &quot;35 Months&quot;)
pcv_4d_35m &lt;- pcv_4d_35m |&gt; filter(`Birth Year/Birth Cohort` %in% c(&#39;2011&#39;, &#39;2012&#39;, &#39;2013&#39;, 
                                                    &#39;2014&#39;, &#39;2015&#39;, &#39;2016&#39;, &#39;2017&#39;, &#39;2018&#39;)) |&gt;
  mutate(year = as.numeric(`Birth Year/Birth Cohort`), region = tolower(Geography))
pcv_map &lt;- pcv_4d_35m |&gt; filter(year %in% c(2011,2012,2013)) |&gt; left_join(us_df)
# pcv_over_time_4d35m &lt;- us_base + geom_polygon(data = pcv_map, aes(fill = `Estimate (%)`))+
#   geom_polygon(color = &quot;gray&quot;, fill = NA) + theme(
#   axis.text = element_blank(),
#   axis.line = element_blank(),
#   axis.ticks = element_blank(),
#   panel.border = element_blank(),
#   panel.grid = element_blank(),
#   axis.title = element_blank()
#   ) + facet_wrap(~year) + scale_fill_gradient(low = &quot;#FFFFFF&quot;, high = &quot;#800000&quot; ) + ggtitle(&quot;PCV Vaccination by 35 months by birth cohort&quot;)
# pcv_over_time_4d35m


pcv_grouping &lt;- pcv_4d_35m |&gt; filter(`Birth Year/Birth Cohort` %in% c(&quot;2011&quot;, &quot;2012&quot;, &quot;2013&quot;)) |&gt; 
  mutate(STATE = Geography, YEAR = as.numeric(`Birth Year/Birth Cohort`)) |&gt;
  select(Vaccine, STATE, `Estimate (%)`, YEAR, `Sample Size`) 
pcv_memb_ag &lt;- coh |&gt; filter(YEAR %in% c(&quot;2011&quot;, &quot;2012&quot;, &quot;2013&quot;), AGEGRP == &quot;00_04&quot;)
pcv_memb_ag &lt;- aggregate(NMEMB ~ STATE + AGEGRP + YEAR, dat = pcv_memb_ag, sum)
pcv_memb_ag &lt;- pcv_memb_ag |&gt; mutate(YEAR = as.numeric(YEAR))
pcv_grouped &lt;- left_join(pcv_grouping, pcv_memb_ag)
pcv_grouped &lt;- pcv_grouped |&gt; mutate(sample_vaxxed = `Estimate (%)`*0.01 *NMEMB)
pcv_grouped &lt;- pcv_grouped |&gt; mutate(state = tolower(STATE))
pcv_grouped &lt;- left_join(pcv_grouped, state_parts_2)
pcv_grouped_2016 &lt;- pcv_grouped |&gt; filter(YEAR == 2011) |&gt; na.omit() #NAs are for regions that aren&#39;t states; ok to omit
pcv_grouped_2017 &lt;- pcv_grouped |&gt; filter(YEAR %in% c(2011, 2012)) |&gt; na.omit()
pcv_grouped_2018 &lt;- pcv_grouped |&gt; na.omit()

pcv_grouped_2016_vaxxed &lt;- aggregate(sample_vaxxed ~ part, data = pcv_grouped_2016, sum)
pcv_grouped_2016_memb &lt;- aggregate(NMEMB ~ part, data = pcv_grouped_2016, sum)
pcv_2016_ag_region &lt;- left_join(pcv_grouped_2016_memb, pcv_grouped_2016_vaxxed) |&gt; mutate(pcv_coverage = sample_vaxxed / NMEMB * 100, YEAR = 2016)

pcv_grouped_2017_vaxxed &lt;- aggregate(sample_vaxxed ~ part, data = pcv_grouped_2017, sum)
pcv_grouped_2017_memb &lt;- aggregate(NMEMB ~part, data = pcv_grouped_2017, sum)
pcv_2017_ag_region &lt;- left_join(pcv_grouped_2017_memb, pcv_grouped_2017_vaxxed) |&gt; mutate(pcv_coverage = sample_vaxxed / NMEMB * 100, YEAR = 2017)

pcv_grouped_2018_vaxxed &lt;- aggregate(sample_vaxxed ~ part, data = pcv_grouped_2018, sum)
pcv_grouped_2018_memb &lt;- aggregate(NMEMB ~part, data = pcv_grouped_2018, sum)
pcv_2018_ag_region &lt;- left_join(pcv_grouped_2018_memb, pcv_grouped_2018_vaxxed) |&gt; mutate(pcv_coverage = sample_vaxxed / NMEMB * 100, YEAR = 2018)

all_pcv &lt;- rbind(pcv_2016_ag_region, pcv_2017_ag_region, pcv_2018_ag_region) |&gt; select(part, pcv_coverage, YEAR) #coverage for 5-9 year olds

#plot it ontop of strep cases 
#look by region over time by age group
by_year_age_region_visits &lt;- aggregate(NVISITS ~ part + AGEGRP + PRIMARYCOND + YEAR, dat = by_year_age, sum)
by_year_age_region_members &lt;- aggregate(NMEMB ~ part + AGEGRP + PRIMARYCOND + YEAR, dat = by_year_age, sum)
by_year_age_region &lt;- left_join(by_year_age_region_visits,by_year_age_region_members)
by_year_age_region &lt;- by_year_age_region |&gt; mutate(CI_per_hundred = NVISITS/NMEMB*100)
strep_for_pcv &lt;- by_year_age_region |&gt; filter(AGEGRP == &quot;05_09&quot;, YEAR %in% c(2016, 2017, 2018)) |&gt;
  mutate(Strep_CI_per_hundred = CI_per_hundred) |&gt; select(part, YEAR, Strep_CI_per_hundred)
strep_pcv &lt;- left_join(strep_for_pcv, all_pcv) |&gt; mutate(Strep_CI_per_five_hundred = Strep_CI_per_hundred *5) |&gt;
  select(-Strep_CI_per_hundred)
strep_pcv_pivoted &lt;- pivot_longer(strep_pcv, cols = c(&quot;Strep_CI_per_five_hundred&quot;, &quot;pcv_coverage&quot;))
# strep_pcv_pivoted|&gt; 
#   ggplot(aes(x= YEAR, y = value, color = part)) + 
#   geom_line(aes(linetype = name)) + scale_x_discrete(limits = c(2016, 2017, 2018))

#maybe separate by region, do barplots
midwest &lt;- strep_pcv_pivoted |&gt; filter(part == &quot;midwest&quot;) |&gt; ggplot(aes(x = YEAR, y = value, fill = name)) + geom_bar(stat = &quot;identity&quot;, color = &quot;black&quot;, position = position_dodge()) + labs(fill = &quot;Value&quot;) + scale_fill_manual(values = c(&quot;#800000&quot;, &quot;#C21807&quot; ), labels = c(&quot;PCV Vaccination %&quot;, &quot;Strep Cases per 500&quot;)) + ylim(0,100) + ggtitle(&quot;PCV Coverage and Strep Pharyngitis Cases Midwest&quot;)

northeast &lt;- strep_pcv_pivoted |&gt; filter(part == &quot;northeast&quot;) |&gt; ggplot(aes(x = YEAR, y = value, fill = name)) + geom_bar(stat = &quot;identity&quot;, color = &quot;black&quot;, position = position_dodge()) + labs(fill = &quot;Value&quot;) + scale_fill_manual(values = c(&quot;#800000&quot;, &quot;#658354&quot; ), labels = c(&quot;PCV Vaccination %&quot;, &quot;Strep Cases per 500&quot;)) + ylim(0,100) + ggtitle(&quot;PCV Coverage and Strep Pharyngitis Cases Northeast&quot;)

west &lt;- strep_pcv_pivoted |&gt; filter(part == &quot;west&quot;) |&gt; ggplot(aes(x = YEAR, y = value, fill = name)) + geom_bar(stat = &quot;identity&quot;, color = &quot;black&quot;, position = position_dodge()) + labs(fill = &quot;Value&quot;) + scale_fill_manual(values = c(&quot;#800000&quot;, &quot;#7852A9&quot; ), labels = c(&quot;PCV Vaccination %&quot;, &quot;Strep Cases per 500&quot;)) + ylim(0,100) + ggtitle(&quot;PCV Coverage and Strep Pharyngitis Cases West&quot;)

south &lt;- strep_pcv_pivoted |&gt; filter(part == &quot;south&quot;) |&gt; ggplot(aes(x = YEAR, y = value, fill = name)) + geom_bar(stat = &quot;identity&quot;, color = &quot;black&quot;, position = position_dodge()) + labs(fill = &quot;Value&quot;) + scale_fill_manual(values = c(&quot;#800000&quot;, &quot;#6699CC&quot; ), labels = c(&quot;PCV Vaccination %&quot;, &quot;Strep Cases per 500&quot;)) + ylim(0,100) + ggtitle(&quot;PCV Coverage and Strep Pharyngitis Cases South&quot;)

# grid.arrange(midwest, northeast, west, south, ncol = 2, nrow =2)

joint4 &lt;- flu_by_month_regions_only |&gt; select(-NVISITS, -NMEMB, -CI_per_ten_thousand, -CI_per_hundred_thousand) |&gt; mutate(Flu_CI_per_thousand = CI_per_thousand) |&gt; select(-CI_per_thousand)
strep_flu_vax_allages &lt;- left_join(joint2,joint4) |&gt; mutate(Strep_CI_per_thousand = CI_per_thousand) |&gt; select(-CI_per_thousand, -Strep_CI_per_ten_thousand)

linmod1 &lt;- lm(Strep_CI_per_thousand ~ part,strep_flu_vax_allages)
summary(linmod1)
strep_flu_vax_allages |&gt; mutate(pred = predict(linmod1, strep_flu_vax_allages)) |&gt; summarize(RMSE = sqrt(mean(pred - Strep_CI_per_thousand)^2))
adjr2_1 &lt;- summary(linmod1)$adj.r.squared
#RMSE 9.969183e-16, R^2: 0.3375, adjusted R^2 0.3328
#try adding in covariates
aic1 &lt;- summary(glm(Strep_CI_per_thousand ~ part,strep_flu_vax_allages, family = gaussian))$aic
#AIC is 1032.722


#add year
linmod2 &lt;- lm(Strep_CI_per_thousand ~ part + as.factor(YEAR), strep_flu_vax_allages)
summary(linmod2) #RMSE 1.040379e-15; R^2 0.3955, Adjusted R^2 0.3797
strep_flu_vax_allages |&gt; mutate(pred = predict(linmod2, strep_flu_vax_allages)) |&gt; summarize(RMSE = sqrt(mean(pred - Strep_CI_per_thousand)^2)) 
aic2 &lt;- summary(glm(Strep_CI_per_thousand ~ part + as.factor(YEAR),strep_flu_vax_allages, family = gaussian))$aic
#AIC 1009.125
adjr2_2 &lt;- summary(linmod2)$adj.r.squared

#add month 
linmod3 &lt;- lm(Strep_CI_per_thousand ~ part + as.factor(YEAR) + as.factor(MONTH),strep_flu_vax_allages)
summary(linmod3) #RMSE 1.345368e-15  R^2 0.865, adjusted R^2 0.8578
strep_flu_vax_allages |&gt; mutate(pred = predict(linmod3, strep_flu_vax_allages)) |&gt; summarize(RMSE = sqrt(mean(pred - Strep_CI_per_thousand)^2))
adjr2_3 &lt;- summary(linmod3)$adj.r.squared
aic3 &lt;- summary(glm(Strep_CI_per_thousand ~ part + as.factor(YEAR) + as.factor(MONTH),strep_flu_vax_allages, family = gaussian))$aic
#AIC 383.3943

#adding in flu vaccination coverage
linmod4 &lt;- lm(Strep_CI_per_thousand ~ part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage, strep_flu_vax_allages)
summary(linmod4) #RMSE 2.252061e-15   R^2 0.873, adjusted R^2 0.8654
strep_flu_vax_allages_nojune &lt;- strep_flu_vax_allages |&gt; filter(MONTH != 6)
adjr2_4 &lt;- summary(linmod4)$adj.r.squared
strep_flu_vax_allages_nojune |&gt; mutate(pred = predict(linmod4, strep_flu_vax_allages_nojune)) |&gt; summarize(RMSE = sqrt(mean(pred - Strep_CI_per_thousand, na.rm = TRUE)^2)) 
aic4 &lt;- summary(glm(Strep_CI_per_thousand ~ part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage,strep_flu_vax_allages, family = gaussian))$aic
#AIC 339.7997

#adding in flu CI as well
linmod5 &lt;- lm(Strep_CI_per_thousand ~ part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand,strep_flu_vax_allages)
summary(linmod5) #RMSE 1.86077e-15 R^2 0.8878, adjusted R^2 0.8807
adjr2_5 &lt;- summary(linmod5)$adj.r.squared
strep_flu_vax_allages_nojune |&gt; mutate(pred = predict(linmod5, strep_flu_vax_allages_nojune)) |&gt; summarize(RMSE = sqrt(mean(pred - Strep_CI_per_thousand, na.rm = TRUE)^2))
aic5 &lt;- summary(glm(Strep_CI_per_thousand ~ part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand,strep_flu_vax_allages, family = gaussian))$aic
#AIC 293.772

#try a month and year interaction term
linmod6 &lt;- lm(Strep_CI_per_thousand ~ part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand + as.factor(YEAR)*as.factor(MONTH),strep_flu_vax_allages)
summary(linmod6) #R^2 0.9191, adjusted R-squared 0.8905
adjr2_6 &lt;- summary(linmod6)$adj.r.squared
aic6 &lt;- summary(glm(Strep_CI_per_thousand ~ part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand + as.factor(YEAR)*as.factor(MONTH),strep_flu_vax_allages, family = gaussian))$aic
#AIC 323.0887

#trying without year
linmod7 &lt;- lm(Strep_CI_per_thousand ~ part + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand,strep_flu_vax_allages)
summary(linmod7) #R^2 0.8339, adjusted r^2 0.8272
adjr2_7 &lt;- summary(linmod7)$adj.r.squared
aic7 &lt;- summary(glm(Strep_CI_per_thousand ~ part + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand,strep_flu_vax_allages, family = gaussian))$aic
#AIC 430.0374

#likelihood ratio test of full model with interactions vs without
lrtest(linmod5, linmod6) #p value of 0.0004; this thinks the interaction term is better

#make a plot of the aics
model_inclusion &lt;- c(&quot;Region only&quot;, &quot;Region and Year&quot;, &quot;Region, Year, Month&quot;, &quot;Region, Year, Month, Flu Vaccination&quot;, &quot;Region, Year, Month, Flu Vaccination, Flu Cases&quot;, &quot;Region, Year, Month, Flu Vaccination, Flu Cases,Year and Month interaction&quot;, &quot;Region, Month, Flu Coverage, Flu Cases&quot;)
AICs &lt;- c(aic1, aic2, aic3, aic4, aic5, aic6, aic7)
R2s &lt;- c(adjr2_1, adjr2_2, adjr2_3, adjr2_4, adjr2_5 ,adjr2_6, adjr2_7)


model_df &lt;- data.frame(Models = model_inclusion, AIC = AICs, &quot;R2&quot; &lt;- R2s)
R2_order &lt;- model_df |&gt; arrange(R2) |&gt; pull(Models)
model_df |&gt; ggplot(aes(x = factor(Models, level = R2_order ), y = R2)) + 
  geom_point() + 
  ylim(0,1) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10), axis.title.x = element_blank()) +
  labs(title = &quot;Adjusted R-squared by Model Parameter Inclusion&quot;)
level_order &lt;- model_df |&gt; arrange(desc(AIC)) |&gt; pull(Models) 
model_df |&gt; ggplot(aes(x = factor(Models, level = level_order ), y = AIC)) + 
  geom_point() + 
  ylim(0,1100) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10), axis.title.x = element_blank()) +
  labs(title = &quot;AIC by Model Parameter Inclusion&quot;)

strep_flu_vax_allages_nojune |&gt; 
  mutate(pred = predict(linmod5, strep_flu_vax_allages_nojune)) |&gt;
  pivot_longer(cols = c(&quot;Strep_CI_per_thousand&quot;, &quot;pred&quot;)) |&gt;
  ggplot(aes(MONTH, value, color = part)) + 
  geom_line(aes(linetype = name)) +
  facet_wrap(~YEAR) +
  scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;, &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  scale_linetype_discrete(name= &quot;Value Plotted&quot;, labels = c(&quot;Predicted Strep Cases per 1000 People&quot;, &quot;Observed Strep Cases per 1000 People&quot;)) + labs(color = &quot;Region&quot;, title = &quot;Predicted and Observed Streptococcal Pharyngitis Cases, All Ages&quot;) 
south &lt;- strep_flu_vax_allages_nojune |&gt; 
  mutate(pred = predict(linmod5, strep_flu_vax_allages_nojune),
         lower = as.data.frame(predict(linmod5, strep_flu_vax_allages_nojune, interval = &quot;confidence&quot;))$lwr, 
         upper = as.data.frame(predict(linmod5, strep_flu_vax_allages_nojune, interval = &quot;confidence&quot;))$upr) |&gt;
  filter(part == &quot;south&quot;) |&gt;
  ggplot(aes(MONTH, Strep_CI_per_thousand)) + 
  geom_line(color = &quot;cyan&quot;) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = &quot;cyan&quot;, alpha = 0.2)+ 
  facet_wrap(~YEAR) +
  scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;, &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + labs(y = &quot;Predicted Strep Cases per 1000 People&quot;) + ggtitle(&quot;South&quot;)

midwest &lt;- strep_flu_vax_allages_nojune |&gt; 
  mutate(pred = predict(linmod5, strep_flu_vax_allages_nojune),
         lower = as.data.frame(predict(linmod5, strep_flu_vax_allages_nojune, interval = &quot;confidence&quot;))$lwr, 
         upper = as.data.frame(predict(linmod5, strep_flu_vax_allages_nojune, interval = &quot;confidence&quot;))$upr) |&gt;
  filter(part == &quot;midwest&quot;) |&gt;
  ggplot(aes(MONTH, Strep_CI_per_thousand)) + 
  geom_line(color = &quot;red&quot;) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = &quot;red&quot;, alpha = 0.2)+ 
  facet_wrap(~YEAR) +
  scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;, &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + labs(y = &quot;Predicted Strep Cases per 1000 People&quot;) + ggtitle(&quot;Midwest&quot;)

northeast &lt;-  strep_flu_vax_allages_nojune |&gt; 
  mutate(pred = predict(linmod5, strep_flu_vax_allages_nojune),
         lower = as.data.frame(predict(linmod5, strep_flu_vax_allages_nojune, interval = &quot;confidence&quot;))$lwr, 
         upper = as.data.frame(predict(linmod5, strep_flu_vax_allages_nojune, interval = &quot;confidence&quot;))$upr) |&gt;
  filter(part == &quot;northeast&quot;) |&gt;
  ggplot(aes(MONTH, Strep_CI_per_thousand)) + 
  geom_line(color = &quot;green&quot;) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = &quot;green&quot;, alpha = 0.2)+ 
  facet_wrap(~YEAR) +
  scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;, &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + labs(y = &quot;Predicted Strep Cases per 1000 People&quot;) + ggtitle(&quot;Northeast&quot;) 

west &lt;- strep_flu_vax_allages_nojune |&gt; 
  mutate(pred = predict(linmod5, strep_flu_vax_allages_nojune),
         lower = as.data.frame(predict(linmod5, strep_flu_vax_allages_nojune, interval = &quot;confidence&quot;))$lwr, 
         upper = as.data.frame(predict(linmod5, strep_flu_vax_allages_nojune, interval = &quot;confidence&quot;))$upr) |&gt;
  filter(part == &quot;west&quot;) |&gt;
  ggplot(aes(MONTH, Strep_CI_per_thousand)) + 
  geom_line(color = &quot;purple&quot;) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = &quot;purple&quot;, alpha = 0.2)+ 
  facet_wrap(~YEAR) +
  scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;, &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + labs(y = &quot;Predicted Strep Cases per 1000 People&quot;) + ggtitle(&quot;West&quot;)


grid.arrange(south, west, northeast, midwest, ncol = 2)

#now try to fit the model just for those 3 years that has the PCV data as well, just for 5-9 years old
flu_by_month_regions_5 &lt;- flu_by_month_regions |&gt; filter(AGEGRP %in% c(&quot;05_09&quot;))
flu_by_month_regions_5_vis &lt;- aggregate(NVISITS ~ part  + YEAR + MONTH, 
                                       dat = flu_by_month_regions_5,
                                       sum)
flu_by_month_regions_5_memb &lt;- aggregate(NMEMB ~ part  + YEAR + MONTH, 
                                       dat = flu_by_month_regions_5,
                                       sum)
flu_by_month_regions_5 &lt;- left_join(flu_by_month_regions_5_vis, flu_by_month_regions_5_memb)
flu_by_month_regions_5 &lt;- flu_by_month_regions_5 |&gt; 
  mutate(&quot;Flu_CI_per_thousand&quot; = NVISITS/NMEMB *1000) |&gt; 
  select(-NVISITS, -NMEMB)
#need to get flu_vax data just for 5-9 age group
#joint3 has flu coverage and strep data
strep_flu_vax_pcv_59 &lt;- left_join(joint3, flu_by_month_regions_5) |&gt; 
  left_join(strep_pcv) |&gt; 
  filter(YEAR %in% c(2016, 2017, 2018)) |&gt; 
  mutate(Strep_CI_per_thousand = CI_per_thousand) |&gt;
  select(-CI_per_thousand, -Strep_CI_per_ten_thousand, -Strep_CI_per_five_thousand, -Strep_CI_per_two_thousand, -Strep_CI_per_five_hundred)
#do same model fit process
pcv_mod1 &lt;- lm(Strep_CI_per_thousand ~part, strep_flu_vax_pcv_59)
summary(pcv_mod1) #R^2 0.3098, adjusted R^2 0.295
pr2_1 &lt;- summary(pcv_mod1)$adj.r.squared
paic1 &lt;- glm(Strep_CI_per_thousand ~part, strep_flu_vax_pcv_59, family = gaussian)$aic
#AIC 907.7759

#add year
pcv_mod2 &lt;- lm(Strep_CI_per_thousand ~part + as.factor(YEAR), strep_flu_vax_pcv_59)
summary(pcv_mod2) #R^2 0.3169, adjusted R^20.2922
pr2_2 &lt;- summary(pcv_mod2)$adj.r.squared
paic2 &lt;- glm(Strep_CI_per_thousand ~part + as.factor(YEAR), strep_flu_vax_pcv_59, family = gaussian)$aic
#AIC 910.283

#add month
pcv_mod3 &lt;- lm(Strep_CI_per_thousand ~part + as.factor(YEAR) + as.factor(MONTH), strep_flu_vax_pcv_59)
summary(pcv_mod3) #R^2 0.8539, adjusted R^2 0.8355
pr2_3 &lt;- summary(pcv_mod3)$adj.r.squared
paic3 &lt;- glm(Strep_CI_per_thousand ~part + as.factor(YEAR) + as.factor(MONTH), strep_flu_vax_pcv_59, family = gaussian)$aic 
#AIC 710.1823


#add flu_coverage 
pcv_mod4 &lt;- lm(Strep_CI_per_thousand ~part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage, strep_flu_vax_pcv_59)
summary(pcv_mod4) #R^2 is 0.8721, adjusted R^2 0.8544
pr2_4 &lt;- summary(pcv_mod4)$adj.r.squared
paic4 &lt;- glm(Strep_CI_per_thousand ~part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage, strep_flu_vax_pcv_59, family = gaussian)$aic 
#AIC 641.2862

#add flu cases
pcv_mod5 &lt;- lm(Strep_CI_per_thousand ~part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand, strep_flu_vax_pcv_59)
summary(pcv_mod5) #R^2 0.8983, adjusted R^2 0.8831
pr2_5 &lt;- summary(pcv_mod5)$adj.r.squared
paic5 &lt;- glm(Strep_CI_per_thousand ~part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand, strep_flu_vax_pcv_59, family = gaussian)$aic 
#AIC 613.0843


#add pcv coverage
pcv_mod6 &lt;- lm(Strep_CI_per_thousand ~part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand + pcv_coverage, strep_flu_vax_pcv_59)
summary(pcv_mod6) #R^2 0.8991, adjusted R^2 0.883; pretty much no change
pr2_6 &lt;- summary(pcv_mod6)$adj.r.squared
paic6 &lt;- glm(Strep_CI_per_thousand ~part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand + pcv_coverage, strep_flu_vax_pcv_59, family = gaussian)$aic 
#AIC 614.0274

#likelihood ratio test of adding vs not adding PCV coverage
lrtest(pcv_mod5, pcv_mod6) #p-value is 0.3039; no benefit to adding PCV coverage

pcv_mod7 &lt;- lm(Strep_CI_per_thousand ~part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand + pcv_coverage + as.factor(YEAR)*as.factor(MONTH), strep_flu_vax_pcv_59)
summary(pcv_mod7) #R^2 0.9156, adjusted R^2 0.8811
pr2_7 &lt;- summary(pcv_mod7)$adj.r.squared
paic7 &lt;- glm(Strep_CI_per_thousand ~part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand + pcv_coverage + as.factor(YEAR)*as.factor(MONTH), strep_flu_vax_pcv_59, family = gaussian)$aic 
#AIC 630.5204

pcv_mod8 &lt;- lm(Strep_CI_per_thousand ~part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand + as.factor(YEAR)*as.factor(MONTH), strep_flu_vax_pcv_59)
summary(pcv_mod8) #R^2 0.9143, adjusted R^2 0.8805
pr2_8 &lt;- summary(pcv_mod8)$adj.r.squared
paic8 &lt;- glm(Strep_CI_per_thousand ~part + as.factor(YEAR) + as.factor(MONTH) + flu_coverage + Flu_CI_per_thousand + as.factor(YEAR)*as.factor(MONTH), strep_flu_vax_pcv_59, family = gaussian)$aic 
#AIC 630.5139


lrtest(pcv_mod6, pcv_mod7) #p-value for interaction vs no interaction is 0.2646; not significant

pmodel_inclusion &lt;- c(&quot;Region only&quot;, &quot;Region and Year&quot;, &quot;Region, Year, and Month&quot;,&quot;Region, Year, Month, and Flu Vaccination&quot;, &quot;Region, Year, Month, Flu Vaccination, and Flu Cases&quot;, &quot;Region, Year, Month, Flu Vaccination, Flu Cases, and PCV Vaccination&quot;, &quot;Region, Year, Month, Flu Vaccination, Flu Cases, PCV Vaccination, Year*Month&quot;, &quot;Region, Year, Month, Flu Vaccination, Flu Cases, Year*Month&quot;)
pAICs &lt;- c(paic1, paic2, paic3, paic4, paic5, paic6, paic7, paic8)
pR2s &lt;- c(pr2_1, pr2_2, pr2_3, pr2_4, pr2_5, pr2_6, pr2_7, pr2_8)

p_model_df &lt;- data.frame(Models = pmodel_inclusion, AIC = pAICs, R2 = pR2s)
pR2_levels &lt;- p_model_df |&gt; arrange(R2) |&gt; pull(Models)
p_level_order &lt;- p_model_df |&gt; arrange(desc(AIC)) |&gt; pull(Models) 

p_model_df |&gt; ggplot(aes(x = factor(Models, level = pR2_levels ), y = R2)) + 
  geom_point() + 
  ylim(0,1) +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10), axis.title.x = element_blank()) +
  labs(title = &quot;Adjusted R-squared by Model Parameter Inclusion, 2016-2018, Ages 5-9&quot;)
p_model_df |&gt; ggplot(aes(x = factor(Models, level = p_level_order ), y = AIC)) + 
  geom_point() + 
  ylim(0,950) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10), axis.title.x = element_blank()) +
  labs(title = &quot;AIC by Model Parameter Inclusion, 2016-2018, Ages 5-9&quot;)

strep_flu_vax_pcv_59_nojune &lt;- strep_flu_vax_pcv_59 |&gt; 
  filter(MONTH != 6) 
strep_flu_vax_pcv_59_nojune |&gt; 
  mutate(pred = predict(pcv_mod5, strep_flu_vax_pcv_59_nojune),
         lower = as.data.frame(predict(pcv_mod5, strep_flu_vax_pcv_59_nojune, interval = &quot;confidence&quot;))$lwr, 
         upper = as.data.frame(predict(pcv_mod5, strep_flu_vax_pcv_59_nojune, interval = &quot;confidence&quot;))$upr) |&gt;
  pivot_longer(cols = c(&quot;Strep_CI_per_thousand&quot;, &quot;pred&quot;)) |&gt; 
  ggplot(aes(MONTH, value, color = part)) + 
  geom_line(aes(linetype = name)) + 
  facet_wrap(~YEAR) +
  scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;, &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  scale_linetype_discrete(name= &quot;Value Plotted&quot;, labels = c(&quot;Predicted Strep Cases per 1000 People&quot;, &quot;Observed Strep Cases per 1000 People&quot;)) + labs(color = &quot;Region&quot;)

south &lt;- strep_flu_vax_pcv_59_nojune |&gt; 
  mutate(pred = predict(pcv_mod5, strep_flu_vax_pcv_59_nojune),
         lower = as.data.frame(predict(pcv_mod5, strep_flu_vax_pcv_59_nojune, interval = &quot;confidence&quot;))$lwr, 
         upper = as.data.frame(predict(pcv_mod5, strep_flu_vax_pcv_59_nojune, interval = &quot;confidence&quot;))$upr) |&gt;
  filter(part == &quot;south&quot;) |&gt;
  ggplot(aes(MONTH, Strep_CI_per_thousand)) + 
  geom_line(color = &quot;cyan&quot;) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = &quot;cyan&quot;, alpha = 0.2)+ 
  facet_wrap(~YEAR) +
  scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;, &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + labs(y = &quot;Predicted Strep Cases per 1000 People&quot;) + ggtitle(&quot;South&quot;) 
midwest &lt;- strep_flu_vax_pcv_59_nojune |&gt; 
  mutate(pred = predict(pcv_mod5, strep_flu_vax_pcv_59_nojune),
         lower = as.data.frame(predict(pcv_mod5, strep_flu_vax_pcv_59_nojune, interval = &quot;confidence&quot;))$lwr, 
         upper = as.data.frame(predict(pcv_mod5, strep_flu_vax_pcv_59_nojune, interval = &quot;confidence&quot;))$upr) |&gt;
  filter(part == &quot;midwest&quot;) |&gt;
  ggplot(aes(MONTH, Strep_CI_per_thousand)) + 
  geom_line(color = &quot;red&quot;) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = &quot;red&quot;, alpha = 0.2)+ 
  facet_wrap(~YEAR) +
  scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;, &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + labs(y = &quot;Predicted Strep Cases per 1000 People&quot;) + ggtitle(&quot;Midwest&quot;) 
northeast &lt;- strep_flu_vax_pcv_59_nojune |&gt; 
  mutate(pred = predict(pcv_mod5, strep_flu_vax_pcv_59_nojune),
         lower = as.data.frame(predict(pcv_mod5, strep_flu_vax_pcv_59_nojune, interval = &quot;confidence&quot;))$lwr, 
         upper = as.data.frame(predict(pcv_mod5, strep_flu_vax_pcv_59_nojune, interval = &quot;confidence&quot;))$upr) |&gt;
  filter(part == &quot;northeast&quot;) |&gt;
  ggplot(aes(MONTH, Strep_CI_per_thousand)) + 
  geom_line(color = &quot;green&quot;) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = &quot;green&quot;, alpha = 0.2)+ 
  facet_wrap(~YEAR) +
  scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;, &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + labs(y = &quot;Predicted Strep Cases per 1000 People&quot;) + ggtitle(&quot;Northeast&quot;) 
west &lt;- strep_flu_vax_pcv_59_nojune |&gt; 
  mutate(pred = predict(pcv_mod5, strep_flu_vax_pcv_59_nojune),
         lower = as.data.frame(predict(pcv_mod5, strep_flu_vax_pcv_59_nojune, interval = &quot;confidence&quot;))$lwr, 
         upper = as.data.frame(predict(pcv_mod5, strep_flu_vax_pcv_59_nojune, interval = &quot;confidence&quot;))$upr) |&gt;
  filter(part == &quot;west&quot;) |&gt;
  ggplot(aes(MONTH, Strep_CI_per_thousand)) + 
  geom_line(color = &quot;purple&quot;) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = &quot;purple&quot;, alpha = 0.2)+ 
  facet_wrap(~YEAR) +
  scale_x_discrete(limits = c(&quot;JAN&quot;, &quot;FEB&quot;, &quot;MAR&quot;, &quot;APR&quot;, &quot;MAY&quot;, &quot;JUN&quot;, &quot;JUL&quot;, &quot;AUG&quot;, &quot;SEPT&quot;, &quot;OCT&quot;, &quot;NOV&quot;, &quot;DEC&quot;)) +
  labs(y = &quot;Predicted Strep Cases per 1000 People&quot;) + ggtitle(&quot;West&quot;) + theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


grid.arrange(south, west, northeast, midwest, ncol = 2)</code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
